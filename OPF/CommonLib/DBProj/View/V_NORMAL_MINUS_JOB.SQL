CREATE OR REPLACE VIEW V_NORMAL_MINUS_JOB
    (PLANT_CD,PLANT_NAME,WH_CD,WH_NAME,ITEM_CD,ITEM_NAME,JOB_ODR_CD,STOCK_ON_HAND_QTY,
    STOCK_UNIT,ABC_TYP,INV_DATE,FLG)
AS
SELECT T_JOB_ODR_CD_STOCK.PLANT_CD AS PLANT_CD,
       M_PLANT.PLANT_NAME AS PLANT_NAME,
       T_JOB_ODR_CD_STOCK.WH_CD AS WH_CD,
       M_WH.WH_NAME AS WH_NAME,
       T_JOB_ODR_CD_STOCK.ITEM_CD AS ITEM_CD,
       M_ITEM.ITEM_NAME AS ITEM_NAME,
       T_JOB_ODR_CD_STOCK.JOB_ODR_CD AS JOB_ODR_CD,
       TO_CHAR(T_JOB_ODR_CD_STOCK.STOCK_ON_HAND_QTY,
               'fm99999999999990.0999') AS STOCK_ON_HAND_QTY,
       M_ITEM.STOCK_UNIT AS STOCK_UNIT,
       M_ITEM.ABC_TYP AS ABC_TYP,
       TO_CHAR(T_INV_CTRL.INV_DATE,'YYYY/MM/DD') AS INV_DATE,
       1      AS  FLG
  FROM T_JOB_ODR_CD_STOCK, M_PLANT, M_ITEM, M_WH,T_INV_CTRL
  WHERE T_JOB_ODR_CD_STOCK.WH_CD = M_WH.WH_CD
   AND T_JOB_ODR_CD_STOCK.ITEM_CD = M_ITEM.ITEM_CD
   AND M_ITEM.ABC_TYP <> 9
   AND M_ITEM.MRP_ODR_TYP <> 8
   AND T_JOB_ODR_CD_STOCK.PLANT_CD = M_PLANT.PLANT_CD
   AND T_INV_CTRL.PLANT_CD = T_JOB_ODR_CD_STOCK.PLANT_CD
   AND T_JOB_ODR_CD_STOCK.ITEM_CD IN
       (SELECT T_INV_CYCLE.ITEM_CD
          FROM T_INV_CYCLE
         WHERE T_INV_CYCLE.PLANT_CD = T_JOB_ODR_CD_STOCK.PLANT_CD
           AND DECODE(TO_CHAR(T_INV_CTRL.INV_DATE,'MM'),'01',T_INV_CYCLE.INV_FLG_JAN,
                                                        '02',T_INV_CYCLE.INV_FLG_FEB,
                                                        '03',T_INV_CYCLE.INV_FLG_MAR,
                                                        '04',T_INV_CYCLE.INV_FLG_APR,
                                                        '05',T_INV_CYCLE.INV_FLG_MAY,
                                                        '06',T_INV_CYCLE.INV_FLG_JUN,
                                                        '07',T_INV_CYCLE.INV_FLG_JUL,
                                                        '08',T_INV_CYCLE.INV_FLG_AUG,
                                                        '09',T_INV_CYCLE.INV_FLG_SEP,
                                                        '10',T_INV_CYCLE.INV_FLG_OCT,
                                                        '11',T_INV_CYCLE.INV_FLG_NOV,
                                                        '12',T_INV_CYCLE.INV_FLG_DEC) = 1)
   UNION
SELECT T_JOB_ODR_CD_STOCK.PLANT_CD AS PLANT_CD,
       M_PLANT.PLANT_NAME AS PLANT_NAME,
       T_JOB_ODR_CD_STOCK.WH_CD AS WH_CD,
       M_WH.WH_NAME AS WH_NAME,
       T_JOB_ODR_CD_STOCK.ITEM_CD AS ITEM_CD,
       M_ITEM.ITEM_NAME AS ITEM_NAME,
       T_JOB_ODR_CD_STOCK.JOB_ODR_CD AS JOB_ODR_CD,
       TO_CHAR(T_JOB_ODR_CD_STOCK.STOCK_ON_HAND_QTY,
               'fm99999999999990.0999') AS STOCK_ON_HAND_QTY,
       M_ITEM.STOCK_UNIT AS STOCK_UNIT,
       M_ITEM.ABC_TYP AS ABC_TYP,
       TO_CHAR(T_INV_CTRL.INV_DATE,'YYYY/MM/DD') AS INV_DATE,
       2      AS  FLG
  FROM T_JOB_ODR_CD_STOCK, M_PLANT, M_ITEM, M_WH,T_INV_CTRL
  WHERE T_JOB_ODR_CD_STOCK.WH_CD = M_WH.WH_CD
   AND T_JOB_ODR_CD_STOCK.ITEM_CD = M_ITEM.ITEM_CD
   AND M_ITEM.ABC_TYP <> 9
   AND M_ITEM.MRP_ODR_TYP <> 8
   AND T_JOB_ODR_CD_STOCK.PLANT_CD = M_PLANT.PLANT_CD
   AND T_INV_CTRL.PLANT_CD = T_JOB_ODR_CD_STOCK.PLANT_CD
   AND ((T_JOB_ODR_CD_STOCK.WH_CD IN
        (SELECT T_INV_TARGET_WH.WH_CD
             FROM T_INV_TARGET_WH
            WHERE TO_CHAR(T_INV_TARGET_WH.INV_DATE,'YYYY/MM/DD') = TO_CHAR(T_INV_CTRL.INV_DATE, 'YYYY/MM/DD')
              AND T_INV_TARGET_WH.PLANT_CD =  T_JOB_ODR_CD_STOCK.PLANT_CD)) OR
        (T_JOB_ODR_CD_STOCK.ITEM_CD IN
        (SELECT T_INV_TARGET_ITEM.ITEM_CD
             FROM T_INV_TARGET_ITEM
            WHERE TO_CHAR(T_INV_TARGET_ITEM.INV_DATE,'YYYY/MM/DD') = TO_CHAR(T_INV_CTRL.INV_DATE, 'YYYY/MM/DD')
              AND T_INV_TARGET_ITEM.PLANT_CD =   T_JOB_ODR_CD_STOCK.PLANT_CD)))
/
