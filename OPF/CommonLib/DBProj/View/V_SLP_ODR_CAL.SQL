/***********************************************************/
/*   販売所要計画情報／受注情報集計ビュー                  */
/***********************************************************/
CREATE OR REPLACE VIEW V_SLP_ODR_CAL
	(
		SALES_PLAN_CD,
		PLN_STR_DATE,
		PLN_END_DATE,
		CUST_CD,
		CUST_ITEM_CD,
		DLV_LOC_CD,
		PLN_QTY,
		REM_QTY
	)AS
	SELECT
		T1.SALES_PLAN_CD,
		T1.PLN_STR_DATE,
		T1.PLN_END_DATE,
		T1.CUST_CD,
		T1.CUST_ITEM_CD,
		T1.DLV_LOC_CD,
		T1.PLN_QTY,
		NVL((T1.PLN_QTY-
			(SELECT
				SUM(SUM_OF_QTY)
			FROM
				(SELECT
					T_ODR_CTL.CUST_CD AS CUST_CD,
					T_ODR_CTL.CUST_ITEM_CD AS CUST_ITEM_CD,
					T_ODR.DLV_LOC_CD AS DLV_LOC_CD,
					T_ODR.DESINATED_DLV_DATE AS DESINATED_DLV_DATE,
					SUM(T_ODR.ODR_QTY) AS SUM_OF_QTY
				FROM
					T_ODR,
					T_ODR_CTL
				WHERE
					T_ODR.ODR_CTL_NO = T_ODR_CTL.ODR_CTL_NO
				AND T_ODR.ODR_TYP = 3
				AND T_ODR.DEL_FLG = 0
				GROUP BY
					T_ODR_CTL.CUST_CD,
					T_ODR_CTL.CUST_ITEM_CD,
					T_ODR.DLV_LOC_CD,
					T_ODR.DESINATED_DLV_DATE,
					T_ODR.ODR_TYP
				UNION ALL
				SELECT
					T_ODR_CTL.CUST_CD AS CUST_CD,
					T_ODR_CTL.CUST_ITEM_CD AS CUST_ITEM_CD,
					T_ODR.DLV_LOC_CD AS DLV_LOC_CD,
					T_ODR.DESINATED_DLV_DATE AS DESINATED_DLV_DATE,
					SUM(T_ODR.REMAIN_UNCONFIRM_ODR_QTY) AS SUM_OF_QTY
				FROM
					T_ODR,
					T_ODR_CTL
				WHERE
					T_ODR.ODR_CTL_NO = T_ODR_CTL.ODR_CTL_NO
				AND T_ODR.ODR_TYP = 2
				AND T_ODR.DEL_FLG = 0
				GROUP BY
					T_ODR_CTL.CUST_CD,
					T_ODR_CTL.CUST_ITEM_CD,
					T_ODR.DLV_LOC_CD,
					T_ODR.DESINATED_DLV_DATE,
					T_ODR.ODR_TYP
				) B
			WHERE
				T1.CUST_CD = B.CUST_CD
			AND T1.CUST_ITEM_CD = B.CUST_ITEM_CD
			AND T1.DLV_LOC_CD = B.DLV_LOC_CD
			AND T1.PLN_STR_DATE <= B.DESINATED_DLV_DATE
			AND T1.PLN_END_DATE >= B.DESINATED_DLV_DATE
			AND T1.DLT_FLG = 0
			)
		),T1.PLN_QTY)
	FROM
		T_SALES_PLAN T1
	ORDER BY 
		T1.SALES_PLAN_CD
/
